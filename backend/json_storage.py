"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ JSON —Ñ–∞–π–ª–µ

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –∑–∞–º–µ–Ω—è–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ —Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º JSON —Ñ–∞–π–ª–µ.
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î (PostgreSQL/SQLite)
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–µ–ø–ª–æ—è
- –õ–µ–≥–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON —Ñ–∞–π–ª–∞:
{
    "users": [
        {"id": 1, "telegram_id": 123456, "username": "user1", "created_at": "2024-01-01T00:00:00"}
    ],
    "listings": [
        {"id": 1, "user_id": 1, "type": "task", "title": "...", ...}
    ],
    "next_user_id": 2,      # –°—á–µ—Ç—á–∏–∫ –¥–ª—è –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    "next_listing_id": 2    # –°—á–µ—Ç—á–∏–∫ –¥–ª—è –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ ID –æ–±—ä—è–≤–ª–µ–Ω–∏–π
}
"""
import json
import os
import threading
from datetime import datetime
from typing import Optional, List, Dict, Any
from pathlib import Path

# ========== –ù–ê–°–¢–†–û–ô–ö–ê –ü–£–¢–ï–ô –ö –§–ê–ô–õ–£ –î–ê–ù–ù–´–• ==========

# –ò–º—è —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DATA_FILE)
DATA_FILE = os.getenv("DATA_FILE", "data.json")

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö
# –í–ê–ñ–ù–û: –ù–∞ Render —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —ç—Ñ–µ–º–µ—Ä–Ω–∞—è, –Ω–æ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (/opt/render/project/src) 
# —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –¥–µ–ø–ª–æ—è–º–∏. –§–∞–π–ª—ã –≤ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è.
# –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DATA_DIR –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –¥–∏—Å–∫–∞.
if os.getenv("DATA_DIR"):
    # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
    # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–º—É –¥–∏—Å–∫—É –Ω–∞ Render
    DATA_DIR = os.getenv("DATA_DIR")
else:
    # –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ backend/)
    # –ù–∞ Render —ç—Ç–æ /opt/render/project/src - –¥–æ–ª–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –º–µ–∂–¥—É –¥–µ–ø–ª–æ—è–º–∏
    current_file_dir = os.path.dirname(os.path.abspath(__file__))  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è backend/
    project_root = os.path.dirname(current_file_dir)                # –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
    DATA_DIR = project_root
    
    # –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Ñ–∞–π–ª —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DATA_DIR
    # –∏ —É–∫–∞–∂–∏ –ø—É—Ç—å –∫ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–º—É –¥–∏—Å–∫—É Render –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–≥–æ–π –º–µ—Ö–∞–Ω–∏–∑–º —Ö—Ä–∞–Ω–µ–Ω–∏—è

# –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–∞–Ω–Ω—ã—Ö
DATA_PATH = os.path.join(DATA_DIR, DATA_FILE)

# –õ–æ–≥–∏—Ä—É–µ–º –ø—É—Ç—å –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
print(f"üìÅ JSON Storage: —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –≤ {DATA_PATH}")

# ========== –ü–û–¢–û–ö–û–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ==========

# –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–ø–∏—Å–∏
# –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö _load_data() –∏ _save_data()
_file_lock = threading.Lock()


def _ensure_data_file():
    """
    –°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    
    –í–ê–ñ–ù–û: –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª!
    –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–Ω –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç—Å—è - —ç—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ—Ç–µ—Ä–∏.
    
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö.
    –°–æ–∑–¥–∞–µ—Ç JSON —Ñ–∞–π–ª —Å –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç:
    - –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    - –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    - –°—á–µ—Ç—á–∏–∫–∏ ID –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 1
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    if os.path.exists(DATA_PATH):
        # –§–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –µ–≥–æ!
        # –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –¥–µ–ø–ª–æ—è–º–∏
        file_size = os.path.getsize(DATA_PATH)
        print(f"üìÅ –§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {DATA_PATH} (—Ä–∞–∑–º–µ—Ä: {file_size} –±–∞–π—Ç)")
        return
    
    # –§–∞–π–ª–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
    print(f"üìÅ –§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π: {DATA_PATH}")
    
    # –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
    initial_data = {
        "users": [],           # –ú–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        "listings": [],        # –ú–∞—Å—Å–∏–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        "next_user_id": 1,     # –°—á–µ—Ç—á–∏–∫ –¥–ª—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç)
        "next_listing_id": 1   # –°—á–µ—Ç—á–∏–∫ –¥–ª—è ID –æ–±—ä—è–≤–ª–µ–Ω–∏–π (–∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç)
    }
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    os.makedirs(DATA_DIR, exist_ok=True)
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª
    # ensure_ascii=False - –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∏—Ä–∏–ª–ª–∏—Ü—É
    # indent=2 - –∫—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
    with open(DATA_PATH, 'w', encoding='utf-8') as f:
        json.dump(initial_data, f, ensure_ascii=False, indent=2)
    
    print(f"‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö: {DATA_PATH}")


def _load_data() -> Dict[str, Any]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON —Ñ–∞–π–ª–∞
    
    –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Å–µ–º–∏ –ø—É–±–ª–∏—á–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –º–æ–¥—É–ª—è.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
    
    Returns:
        Dict —Å –¥–∞–Ω–Ω—ã–º–∏: {"users": [...], "listings": [...], "next_user_id": N, ...}
    
    Raises:
        –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ñ–∞–π–ª –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–ø—ã—Ç–∫—É
    """
    # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    _ensure_data_file()
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏
    with _file_lock:
        try:
            # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏ –ø–∞—Ä—Å–∏–º JSON
            with open(DATA_PATH, 'r', encoding='utf-8') as f:
                return json.load(f)
        except (FileNotFoundError, json.JSONDecodeError):
            # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON)
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            _ensure_data_file()
            # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
            return _load_data()


def _save_data(data: Dict[str, Any]):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON —Ñ–∞–π–ª
    
    –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω—É—é –∑–∞–ø–∏—Å—å:
    1. –°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª .tmp
    2. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ–≥–æ
    3. –ê—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –Ω–æ–≤—ã–º (os.replace)
    
    –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –±—É–¥–µ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –ø—Ä–∏ —Å–±–æ–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
    
    Args:
        data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        
    Raises:
        Exception: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª
    """
    with _file_lock:
        try:
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –µ—ë —É–¥–∞–ª–∏–ª–∏)
            os.makedirs(DATA_DIR, exist_ok=True)
            
            # –ê–¢–û–ú–ê–†–ù–ê–Ø –ó–ê–ü–ò–°–¨:
            # –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, –ø–æ—Ç–æ–º –∞—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π
            # –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏
            temp_path = DATA_PATH + ".tmp"
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            with open(temp_path, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
            
            # –ê—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –Ω–æ–≤—ã–º
            # os.replace() - –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (–Ω–∞ Unix —Å–∏—Å—Ç–µ–º–∞—Ö)
            # –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —É–ø–∞–¥–µ—Ç –∑–¥–µ—Å—å, —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ü–µ–ª—ã–º
            os.replace(temp_path, DATA_PATH)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–∏—Å–∞–Ω
            if os.path.exists(DATA_PATH):
                file_size = os.path.getsize(DATA_PATH)
                print(f"üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {DATA_PATH} (—Ä–∞–∑–º–µ—Ä: {file_size} –±–∞–π—Ç)")
            else:
                print(f"‚ùå –û–®–ò–ë–ö–ê: —Ñ–∞–π–ª {DATA_PATH} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!")
                
        except Exception as e:
            # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {type(e).__name__}: {e}")
            import traceback
            traceback.print_exc()
            raise


# ========== –†–ê–ë–û–¢–ê –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò ==========

def get_user_by_telegram_id(telegram_id: int) -> Optional[Dict[str, Any]]:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id
    
    Args:
        telegram_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    """
    data = _load_data()
    # –õ–∏–Ω–µ–π–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –º–∞—Å—Å–∏–≤—É (–¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä–æ)
    for user in data["users"]:
        if user["telegram_id"] == telegram_id:
            return user
    return None


def get_user_by_id(user_id: int) -> Optional[Dict[str, Any]]:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É ID
    
    Args:
        user_id: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ –ø–æ–ª—è "id")
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    """
    data = _load_data()
    for user in data["users"]:
        if user["id"] == user_id:
            return user
    return None


def create_user(telegram_id: int, username: Optional[str] = None) -> Dict[str, Any]:
    """
    –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
    
    –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º telegram_id —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –û–±–Ω–æ–≤–ª—è–µ—Ç username –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
    
    –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç:
    - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ —Å –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–º ID
    - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ñ–∞–π–ª
    
    Args:
        telegram_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    data = _load_data()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º telegram_id
    existing = get_user_by_telegram_id(telegram_id)
    if existing:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å - –æ–±–Ω–æ–≤–ª—è–µ–º username –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
        if username and existing.get("username") != username:
            existing["username"] = username
            _save_data(data)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        return existing
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = {
        "id": data["next_user_id"],        # –ê–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–π ID
        "telegram_id": telegram_id,        # Telegram ID
        "username": username,              # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        "created_at": datetime.now().isoformat()  # –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è (ISO —Ñ–æ—Ä–º–∞—Ç)
    }
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ ID
    data["users"].append(user)
    data["next_user_id"] += 1
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª
    _save_data(data)
    
    return user


def update_user_username(user_id: int, username: str):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        user_id: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        username: –ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    data = _load_data()
    # –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º username
    for user in data["users"]:
        if user["id"] == user_id:
            user["username"] = username
            _save_data(data)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            return


# ========== –†–ê–ë–û–¢–ê –° –û–ë–™–Ø–í–õ–ï–ù–ò–Ø–ú–ò ==========

def create_listing(
    user_id: int,
    listing_type: str,
    title: str,
    description: str,
    address: str,
    payment: str,
    contacts: str,
    latitude: float,
    longitude: float,
    status: str = "active"
) -> Dict[str, Any]:
    """
    –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ (–∑–∞–¥–∞—á—É –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è)
    
    –ü—Ä–æ—Ü–µ—Å—Å:
    1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
    2. –°–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–º ID
    3. –î–æ–±–∞–≤–ª—è–µ—Ç –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    4. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ next_listing_id
    5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ñ–∞–π–ª
    6. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–∞–≤—Ç–æ—Ä–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        listing_type: –¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏—è ("task" –∏–ª–∏ "worker")
        title: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        description: –û–ø–∏—Å–∞–Ω–∏–µ
        address: –ê–¥—Ä–µ—Å
        payment: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ
        contacts: –ö–æ–Ω—Ç–∞–∫—Ç—ã
        latitude: –®–∏—Ä–æ—Ç–∞ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞)
        longitude: –î–æ–ª–≥–æ—Ç–∞ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞)
        status: –°—Ç–∞—Ç—É—Å ("active" –∏–ª–∏ "closed")
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    """
    print(f"üìù –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è: —Ç–∏–ø={listing_type}, –∑–∞–≥–æ–ª–æ–≤–æ–∫={title[:30]}...")
    print(f"üìÅ –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–∞–Ω–Ω—ã—Ö: {DATA_PATH}")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    data = _load_data()
    print(f"üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π={len(data['users'])}, –æ–±—ä—è–≤–ª–µ–Ω–∏–π={len(data['listings'])}")
    
    # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    listing = {
        "id": data["next_listing_id"],      # –ê–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–π ID
        "user_id": user_id,                 # ID –∞–≤—Ç–æ—Ä–∞
        "type": listing_type,               # –¢–∏–ø: "task" –∏–ª–∏ "worker"
        "title": title,                     # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        "description": description,         # –û–ø–∏—Å–∞–Ω–∏–µ
        "address": address,                 # –ê–¥—Ä–µ—Å
        "payment": payment,                # –û–ø–ª–∞—Ç–∞
        "contacts": contacts,               # –ö–æ–Ω—Ç–∞–∫—Ç—ã
        "latitude": latitude,               # –®–∏—Ä–æ—Ç–∞
        "longitude": longitude,            # –î–æ–ª–≥–æ—Ç–∞
        "status": status,                  # –°—Ç–∞—Ç—É—Å: "active" –∏–ª–∏ "closed"
        "created_at": datetime.now().isoformat()  # –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
    }
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ ID
    data["listings"].append(listing)
    data["next_listing_id"] += 1
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª
    print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è ID={listing['id']}...")
    _save_data(data)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
    # –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
    verify_data = _load_data()
    if len(verify_data["listings"]) != len(data["listings"]):
        print(f"‚ùå –û–®–ò–ë–ö–ê: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç! –ë—ã–ª–æ: {len(data['listings'])}, –°—Ç–∞–ª–æ: {len(verify_data['listings'])}")
    else:
        print(f"‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –≤—Å–µ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: {len(verify_data['listings'])}")
    
    return listing


def get_listing_by_id(listing_id: int) -> Optional[Dict[str, Any]]:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–æ ID
    
    Args:
        listing_id: ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    """
    data = _load_data()
    # –õ–∏–Ω–µ–π–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –º–∞—Å—Å–∏–≤—É
    for listing in data["listings"]:
        if listing["id"] == listing_id:
            return listing
    return None


def get_listings(
    listing_type: Optional[str] = None,
    status: str = "active",
    user_id: Optional[int] = None
) -> List[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
    
    –§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ:
    1. –ü–æ —Å—Ç–∞—Ç—É—Å—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "active")
    2. –ü–æ —Ç–∏–ø—É (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    3. –ü–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    
    Args:
        listing_type: –¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏—è ("task" –∏–ª–∏ "worker"), None = –≤—Å–µ —Ç–∏–ø—ã
        status: –°—Ç–∞—Ç—É—Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è ("active" –∏–ª–∏ "closed")
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, None = –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        
    Returns:
        –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º
    """
    data = _load_data()
    listings = data["listings"]
    
    # –®–∞–≥ 1: –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Å—Ç–∞—Ç—É—Å—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ)
    filtered = [l for l in listings if l.get("status") == status]
    
    # –®–∞–≥ 2: –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø—É (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    if listing_type:
        filtered = [l for l in filtered if l.get("type") == listing_type]
    
    # –®–∞–≥ 3: –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    if user_id:
        filtered = [l for l in filtered if l.get("user_id") == user_id]
    
    return filtered


def update_listing_status(listing_id: int, status: str):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ)
    
    Args:
        listing_id: ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        status: –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å ("active" –∏–ª–∏ "closed")
        
    Returns:
        True –µ—Å–ª–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ, False –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    """
    data = _load_data()
    # –ò—â–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    for listing in data["listings"]:
        if listing["id"] == listing_id:
            listing["status"] = status
            _save_data(data)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            return True
    return False


def get_user_listings(user_id: int, status: str = "active") -> List[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    –£–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è-–æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ get_listings() –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è
    –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        status: –°—Ç–∞—Ç—É—Å –æ–±—ä—è–≤–ª–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "active")
        
    Returns:
        –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    return get_listings(status=status, user_id=user_id)


def get_stats() -> Dict[str, int]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –¥–∞–Ω–Ω—ã–º –≤ —Ñ–∞–π–ª–µ
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π:
        - users_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        - listings_count: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        - active_listings_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    """
    data = _load_data()
    return {
        "users_count": len(data["users"]),
        "listings_count": len(data["listings"]),
        "active_listings_count": len([l for l in data["listings"] if l.get("status") == "active"])
    }


def get_all_data() -> Dict[str, Any]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ (–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/–æ—Ç–ª–∞–¥–∫–∏)
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ admin endpoints –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
    –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∑–∞—â–∏—Ç–∏—Ç—å —ç—Ç–æ—Ç endpoint –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π.
    
    Returns:
        –ü–æ–ª–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞
    """
    return _load_data()


def get_file_path() -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–∞–Ω–Ω—ã—Ö
    
    Returns:
        –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É data.json
    """
    return DATA_PATH


def get_file_info() -> Dict[str, Any]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ admin endpoints –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
        - file_path: –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        - file_exists: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
        - file_size_bytes: —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö
        - file_size_kb: —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –∫–∏–ª–æ–±–∞–π—Ç–∞—Ö
        - stats: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∏ —Ç.–¥.)
    """
    file_exists = os.path.exists(DATA_PATH)
    file_size = os.path.getsize(DATA_PATH) if file_exists else 0
    stats = get_stats()
    
    return {
        "file_path": DATA_PATH,
        "file_exists": file_exists,
        "file_size_bytes": file_size,
        "file_size_kb": round(file_size / 1024, 2) if file_exists else 0,
        "stats": stats
    }

